<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saved Routes - naviga8</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center">
    <!-- NAVIGATION -->
    <nav
      class="w-full px-4 sm:px-6 py-4 flex justify-between items-center bg-white shadow-lg"
    >
      <p class="text-xl sm:text-2xl font-bold font-sans px-4 sm:px-6 py-3">naviga8</p>
      <button
        id="backToMapBtn"
        class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 hover:bg-green-800 transition-colors font-bold font-serif"
      >
        Back to Map
      </button>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="text-center mt-8 sm:mt-12 px-4 max-w-[800px] w-full">
      <h1 class="font-sans font-bold text-2xl sm:text-4xl mb-6">Saved Routes</h1>
      <div id="loadingMessage" class="text-gray-600 mb-4">Loading routes...</div>
      <div id="routesList" class="flex flex-col gap-4"></div>
    </div>

<script>
// ====== USER ID ======
let userId = localStorage.getItem("naviga8_userId");

async function getOrCreateUserId() {
    if (userId) return userId;
    try {
        const res = await fetch("/api/user-id");
        if (!res.ok) throw new Error("Failed to get user ID");
        const data = await res.json();
        userId = data.userId;
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    } catch (err) {
        console.error("User ID error:", err);
        userId = Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    }
}

// ====== PAGE FUNCTIONS ======
document.getElementById("backToMapBtn").addEventListener("click", () => {
    window.location.href = "map.html";
});

async function fetchSavedRoutes() {
    const routesList = document.getElementById("routesList");
    const loadingMessage = document.getElementById("loadingMessage");
    
    try {
        const currentUserId = await getOrCreateUserId();
        const res = await fetch(`/routes?userId=${encodeURIComponent(currentUserId)}`);
        if (!res.ok) throw new Error("Failed to fetch routes");

        const routes = await res.json();
        
        // Hide loading message
        if (loadingMessage) {
            loadingMessage.style.display = "none";
        }
        
        routesList.innerHTML = "";

        if (!Array.isArray(routes) || routes.length === 0) {
            routesList.innerHTML = "<p class='text-gray-600 text-center py-8'>No saved routes yet.</p>";
            return;
        }

        routes.forEach((route) => {
            const id = route._id || route.id || "";
            const origin = route.origin?.address || "";
            const destination = route.destination?.address || "";

            const div = document.createElement("div");
            div.className = "bg-white p-4 rounded shadow flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4";
            div.innerHTML = `
                <div class="flex-1">
                    <p class="break-words"><strong>Origin:</strong> ${escapeHtml(origin)}</p>
                    <p class="break-words"><strong>Destination:</strong> ${escapeHtml(destination)}</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button class="bg-red-700 text-white px-5 py-3 rounded deleteBtn text-sm sm:text-base hover:bg-red-800 transition-colors" data-id="${id}">
                        Delete
                    </button>
                    <button class="bg-green-700 text-white px-5 py-3 rounded viewBtn text-sm sm:text-base hover:bg-green-800 transition-colors"
                        data-origin="${encodeURIComponent(origin)}" 
                        data-destination="${encodeURIComponent(destination)}">
                        View on Map
                    </button>
                </div>
            `;
            routesList.appendChild(div);
        });

        // Delete route
        document.querySelectorAll(".deleteBtn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                const id = e.currentTarget.dataset.id;
                if (!id) return;
                
                if (!confirm("Are you sure you want to delete this route?")) return;
                
                try {
                    const currentUserId = await getOrCreateUserId();
                    const res = await fetch(`/delete-route/${id}?userId=${encodeURIComponent(currentUserId)}`, {
                        method: "DELETE",
                    });
                    if (!res.ok) console.error("Delete failed", res.statusText);
                    fetchSavedRoutes();
                } catch (err) {
                    console.error(err);
                }
            });
        });

        // View on map
        document.querySelectorAll(".viewBtn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const origin = decodeURIComponent(e.currentTarget.dataset.origin || "");
                const destination = decodeURIComponent(e.currentTarget.dataset.destination || "");
                sessionStorage.setItem("returnOrigin", origin);
                sessionStorage.setItem("returnDestination", destination);
                sessionStorage.setItem("hadRoute", "true");
                window.location.href = "map.html";
            });
        });
    } catch (err) {
        console.error(err);
        // Hide loading message on error too
        if (loadingMessage) {
            loadingMessage.style.display = "none";
        }
        routesList.innerHTML = "<p class='text-red-600 text-center py-8'>Error loading saved routes. Please try again.</p>";
    }
}

function escapeHtml(text) {
    if (!text) return "";
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Load routes when page loads
document.addEventListener("DOMContentLoaded", () => {
    fetchSavedRoutes();
});
</script>
  </body>
</html>
