<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>naviga8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom responsive fixes */
      @media (max-width: 768px) {
        .input-group {
          flex-direction: column;
          width: 100%;
        }
        .input-group input {
          width: 100%;
          margin-bottom: 8px;
        }
        .button-group {
          flex-wrap: wrap;
          justify-content: center;
        }
        .button-group button {
          margin: 4px;
          flex: 1;
          min-width: 120px;
        }
      }
      /* Loading spinner animation */
      .loading-spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Dark Mode Colors */
      .dark-bg {
        background-color: #111827;
      }
      .dark-text {
        color: #f9fafb;
      }
      .dark-input {
        background-color: #374151;
        color: #f9fafb;
        border-color: #4b5563;
      }
      .dark-card {
        background-color: #1f2937;
      }
      .dark-subtle {
        color: #d1d5db;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col items-center bg-[url('./bg-lines.svg')]"
  >
    <!-- NAVIGATION -->
    <nav class="w-full px-4 py-4 flex justify-between items-center bg-white shadow-lg">
      <p class="text-xl sm:text-2xl font-bold font-sans px-4 sm:px-6 py-3">naviga8</p>
      <div class="flex items-center gap-3">
        <!-- DARK MODE TOGGLE -->
        <button
          id="darkModeToggle"
          class="rounded-full p-3 bg-gray-100 hover:bg-gray-200 transition-colors"
          title="Toggle dark mode"
        >
          <span id="darkModeIcon" class="text-xl">üåô</span>
        </button>
        <!-- GET STARTED BUTTON -->
        <button
          id="getStartedBtn"
          class="rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 bg-green-700 hover:bg-green-800 transition-colors font-bold font-serif"
        >
          Get started for free!
        </button>
      </div>
    </nav>

    <!-- HERO SECTION -->
    <div class="text-center mt-8 sm:mt-12 px-4 w-full">
      <h1
        class="font-sans font-bold tracking-tighter leading-[1.1] text-black max-w-[1100px] mx-auto text-3xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-[100px]"
      >
        Find Your Way with Seamless <br class="hidden sm:block" />Navigation
      </h1>

      <p
        class="text-gray-600 font-medium text-base sm:text-lg md:text-xl max-w-[800px] mx-auto mt-4 sm:mt-6 mb-6 sm:mb-8"
      >
        Discover locations, search for places, and get accurate directions with
        our intuitive map app. Simplify your journeys like never before.
      </p>

      <!-- EXPLORE BUTTON -->
      <div class="flex justify-center gap-4 mb-12 sm:mb-24 flex-wrap">
        <button
          id="exploreMapBtn"
          class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-9 py-3 hover:bg-green-800 transition-colors font-bold font-serif"
        >
          Explore App Below
        </button>
      </div>

      <!-- MAP CONTAINER -->
      <div class="bg-gray-200 p-4 sm:p-8 rounded-lg max-w-[1200px] mx-auto mb-12 sm:mb-24 w-full shadow-xl">
        <!-- VIEW SAVED ROUTES BUTTON -->
        <div class="flex justify-start mb-6 sm:mb-8">
          <button
            id="viewSavedRoutesBtn"
            class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 hover:bg-green-800 transition-colors font-bold font-serif"
          >
            View Saved Routes
          </button>
        </div>

        <!-- INPUTS & ACTION BUTTONS -->
        <div class="flex gap-3 sm:gap-4 flex-wrap items-start">
          <div class="flex gap-2 flex-1 input-group">
            <div class="flex gap-2 flex-1 w-full">
              <span class="text-gray-700 text-xl">üìç</span>
              <input
                id="origin"
                placeholder="Origin"
                class="flex-1 px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm sm:text-base"
              />
            </div>
            <div class="flex gap-2 flex-1 w-full">
              <span class="text-gray-700 text-xl">üìç</span>
              <input
                id="destination"
                placeholder="Destination"
                class="flex-1 px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm sm:text-base"
              />
            </div>
          </div>

          <div class="flex gap-2 sm:gap-4 button-group w-full sm:w-auto">
            <button
              id="getRoutesBtn"
              class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-6 py-3 hover:bg-green-800 transition-colors font-bold font-serif flex-1"
            >
              Get Routes
            </button>

            <button
              id="saveRouteBtn"
              class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-6 py-3 hover:bg-green-800 transition-colors font-bold font-serif flex items-center gap-1 flex-1"
            >
              Save Route
            </button>

            <button
              id="clearBtn"
              class="text-red-600 font-bold hover:underline px-5 py-3 rounded-lg border border-red-600 hover:bg-red-50 text-sm sm:text-base flex-1 transition-colors"
            >
              üóë Clear
            </button>
          </div>
        </div>

        <!-- MAP DISPLAY WITH LOADING -->
        <div
          id="map"
          class="mt-6 sm:mt-8 w-full h-[300px] sm:h-[400px] md:h-[500px] bg-gray-300 rounded-lg relative overflow-hidden"
        >
          <!-- LOADING SPINNER -->
          <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-300">
            <div class="text-center">
              <div class="inline-block loading-spinner rounded-full h-10 w-10 border-4 border-green-800 border-t-transparent"></div>
              <p class="mt-3 text-gray-700 font-medium">Loading map...</p>
            </div>
          </div>
          <!-- ACTUAL MAP CONTAINER (HIDDEN INITIALLY) -->
          <div id="mapContainer" class="hidden w-full h-full"></div>
        </div>
      </div>
    </div>

<script>
// ====== SIMPLE DARK MODE ======
function toggleDarkMode() {
  const darkModeToggle = document.getElementById("darkModeToggle");
  const darkModeIcon = document.getElementById("darkModeIcon");
  const body = document.body;
  const mapContainer = document.querySelector('.bg-gray-200');
  const inputs = document.querySelectorAll('input');
  const paragraphs = document.querySelectorAll('p.text-gray-600, p.text-black, h1.text-black');
  const headings = document.querySelectorAll('h1, h2, h3');
  const cards = document.querySelectorAll('.bg-white, .bg-gray-200, .bg-gray-300');
  
  // Check saved preference
  const isDarkMode = localStorage.getItem("naviga8_darkMode") === "true";
  
  if (isDarkMode) {
    // Apply dark mode
    body.classList.remove("bg-[url('./bg-lines.svg')]");
    body.classList.add("dark-bg", "dark-text");
    darkModeIcon.textContent = "‚òÄÔ∏è";
    
    // Update all elements
    mapContainer.classList.remove("bg-gray-200");
    mapContainer.classList.add("dark-card");
    
    document.querySelector('#map .bg-gray-300').classList.remove("bg-gray-300");
    document.querySelector('#map .bg-gray-300').classList.add("dark-card");
    
    inputs.forEach(input => {
      input.classList.remove("border-gray-300");
      input.classList.add("dark-input");
    });
    
    paragraphs.forEach(p => {
      if (p.classList.contains("text-gray-600")) {
        p.classList.remove("text-gray-600");
        p.classList.add("dark-subtle");
      }
      if (p.classList.contains("text-black")) {
        p.classList.remove("text-black");
        p.classList.add("dark-text");
      }
    });
    
    headings.forEach(h => {
      if (h.classList.contains("text-black")) {
        h.classList.remove("text-black");
        h.classList.add("dark-text");
      }
    });
    
    // Update text colors
    document.querySelectorAll('.text-gray-700').forEach(el => {
      el.classList.remove("text-gray-700");
      el.classList.add("dark-subtle");
    });
    
    // Update loading text
    document.querySelector('#mapLoading p').classList.remove("text-gray-700");
    document.querySelector('#mapLoading p').classList.add("dark-subtle");
  }
  
  // Toggle dark mode
  darkModeToggle.addEventListener("click", () => {
    const isDark = !body.classList.contains("dark-bg");
    
    if (isDark) {
      // Enable dark mode
      body.classList.remove("bg-[url('./bg-lines.svg')]");
      body.classList.add("dark-bg", "dark-text");
      darkModeIcon.textContent = "‚òÄÔ∏è";
      
      // Update elements
      mapContainer.classList.remove("bg-gray-200");
      mapContainer.classList.add("dark-card");
      
      document.querySelector('#map .bg-gray-300').classList.remove("bg-gray-300");
      document.querySelector('#map .bg-gray-300').classList.add("dark-card");
      
      inputs.forEach(input => {
        input.classList.remove("border-gray-300");
        input.classList.add("dark-input");
      });
      
      paragraphs.forEach(p => {
        if (p.classList.contains("text-gray-600")) {
          p.classList.remove("text-gray-600");
          p.classList.add("dark-subtle");
        }
        if (p.classList.contains("text-black")) {
          p.classList.remove("text-black");
          p.classList.add("dark-text");
        }
      });
      
      headings.forEach(h => {
        if (h.classList.contains("text-black")) {
          h.classList.remove("text-black");
          h.classList.add("dark-text");
        }
      });
      
      // Update other text
      document.querySelectorAll('.text-gray-700').forEach(el => {
        el.classList.remove("text-gray-700");
        el.classList.add("dark-subtle");
      });
      
      // Update loading text
      document.querySelector('#mapLoading p').classList.remove("text-gray-700");
      document.querySelector('#mapLoading p').classList.add("dark-subtle");
      
    } else {
      // Disable dark mode
      body.classList.remove("dark-bg", "dark-text");
      body.classList.add("bg-[url('./bg-lines.svg')]");
      darkModeIcon.textContent = "üåô";
      
      // Restore light mode
      mapContainer.classList.remove("dark-card");
      mapContainer.classList.add("bg-gray-200");
      
      document.querySelector('#map .bg-gray-300').classList.remove("dark-card");
      document.querySelector('#map .bg-gray-300').classList.add("bg-gray-300");
      
      inputs.forEach(input => {
        input.classList.remove("dark-input");
        input.classList.add("border-gray-300");
      });
      
      paragraphs.forEach(p => {
        if (p.classList.contains("dark-subtle")) {
          p.classList.remove("dark-subtle");
          p.classList.add("text-gray-600");
        }
        if (p.classList.contains("dark-text")) {
          p.classList.remove("dark-text");
          p.classList.add("text-black");
        }
      });
      
      headings.forEach(h => {
        if (h.classList.contains("dark-text")) {
          h.classList.remove("dark-text");
          h.classList.add("text-black");
        }
      });
      
      // Restore other text
      document.querySelectorAll('.dark-subtle').forEach(el => {
        el.classList.remove("dark-subtle");
        el.classList.add("text-gray-700");
      });
      
      // Restore loading text
      document.querySelector('#mapLoading p').classList.remove("dark-subtle");
      document.querySelector('#mapLoading p').classList.add("text-gray-700");
    }
    
    localStorage.setItem("naviga8_darkMode", isDark);
  });
}

// ====== USER ID ======
let userId = localStorage.getItem("naviga8_userId");

async function getOrCreateUserId() {
    if (userId) return userId;
    try {
        const res = await fetch("/api/user-id");
        if (!res.ok) throw new Error("Failed to get user ID");
        const data = await res.json();
        userId = data.userId;
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    } catch (err) {
        console.error("User ID error:", err);
        userId = Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    }
}

// ====== MAP FUNCTIONS ======
let map;
let directionsService;
let directionsRenderer;

function saveInputsLocally() {
    localStorage.setItem("lastOrigin", document.getElementById("origin").value);
    localStorage.setItem("lastDestination", document.getElementById("destination").value);
}

function loadInputs() {
    const o = localStorage.getItem("lastOrigin");
    const d = localStorage.getItem("lastDestination");
    if (o) document.getElementById("origin").value = o;
    if (d) document.getElementById("destination").value = d;
}

function initMap() {
    if (map) return;

    const defaultCenter = { lat: 6.866687, lng: 7.411784 };
    const savedCenter = JSON.parse(sessionStorage.getItem("MAP_CENTER")) || defaultCenter;
    const savedZoom = parseInt(sessionStorage.getItem("MAP_ZOOM")) || 17;
    const savedType = sessionStorage.getItem("MAP_TYPE") || "roadmap";

    // Create map in the mapContainer (not directly in #map)
    map = new google.maps.Map(document.getElementById("mapContainer"), {
        center: savedCenter,
        zoom: savedZoom,
        mapTypeId: savedType,
    });

    new google.maps.Marker({
        position: defaultCenter,
        map: map,
        title: "My School",
    });

    if (!directionsRenderer) {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
    }

    loadInputs();

    const returnOrigin = sessionStorage.getItem("returnOrigin");
    const returnDestination = sessionStorage.getItem("returnDestination");
    const hadRoute = sessionStorage.getItem("hadRoute");

    if (hadRoute && returnOrigin && returnDestination) {
        document.getElementById("origin").value = returnOrigin;
        document.getElementById("destination").value = returnDestination;
        calculateRoute(returnOrigin, returnDestination);
        sessionStorage.removeItem("returnOrigin");
        sessionStorage.removeItem("returnDestination");
        sessionStorage.removeItem("hadRoute");
    }

    loadRouteFromURL();

    // Hide loading spinner, show map
    document.getElementById("mapLoading").classList.add("hidden");
    document.getElementById("mapContainer").classList.remove("hidden");

    map.addListener("center_changed", () => {
        sessionStorage.setItem("MAP_CENTER", JSON.stringify(map.getCenter().toJSON()));
    });
    map.addListener("zoom_changed", () => {
        sessionStorage.setItem("MAP_ZOOM", map.getZoom());
    });
    map.addListener("maptypeid_changed", () => {
        sessionStorage.setItem("MAP_TYPE", map.getMapTypeId());
    });
}

function calculateRoute(originVal, destinationVal) {
    const origin = originVal || document.getElementById("origin").value;
    const destination = destinationVal || document.getElementById("destination").value;

    if (!origin || !destination) {
        alert("Enter both origin and destination");
        return;
    }
    
    if (!directionsService || !directionsRenderer) {
        alert("Map is not ready yet");
        return;
    }

    // Show loading state on button
    const routeBtn = document.getElementById("getRoutesBtn");
    const originalText = routeBtn.innerHTML;
    routeBtn.innerHTML = "Calculating...";
    routeBtn.disabled = true;

    directionsService.route(
        { origin, destination, travelMode: "DRIVING" },
        (result, status) => {
            // Restore button
            routeBtn.disabled = false;
            routeBtn.innerHTML = originalText;
            
            if (status === "OK") {
                directionsRenderer.setDirections(result);
                saveInputsLocally();
            } else {
                alert("Route not found: " + status);
            }
        }
    );
}

function loadRouteFromURL() {
    const params = new URLSearchParams(window.location.search);
    const o = params.get("origin");
    const d = params.get("destination");
    if (o && d) {
        document.getElementById("origin").value = o;
        document.getElementById("destination").value = d;
        calculateRoute(o, d);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    // Initialize dark mode
    toggleDarkMode();
    
    document.getElementById("getStartedBtn").addEventListener("click", () => {
        document.getElementById("map").scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("getRoutesBtn").addEventListener("click", () => calculateRoute());

    document.getElementById("saveRouteBtn").addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        const origin = document.getElementById("origin").value.trim();
        const destination = document.getElementById("destination").value.trim();
        if (!origin || !destination)
            return alert("Enter both origin and destination!");

        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = "Saving...";

        try {
            const currentUserId = await getOrCreateUserId();
            const res = await fetch("/save-route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: currentUserId,
                    origin: { address: origin },
                    destination: { address: destination },
                }),
            });

            if (res.ok) {
                btn.innerHTML = "Saved ‚úî";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 1500);
            } else {
                const err = await res.json().catch(() => ({}));
                alert("Could not save: " + (err.msg || res.statusText));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (err) {
            console.error(err);
            alert("Network error saving route");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    document.getElementById("viewSavedRoutesBtn").addEventListener("click", () => {
        sessionStorage.setItem("returnOrigin", document.getElementById("origin").value);
        sessionStorage.setItem("returnDestination", document.getElementById("destination").value);
        sessionStorage.setItem("hadRoute", "true");
        window.location.href = "saved-routes.html";
    });

    document.getElementById("exploreMapBtn").addEventListener("click", () => {
        window.scrollTo({
            top: document.getElementById("map").offsetTop,
            behavior: "smooth"
        });
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("origin").value = "";
        document.getElementById("destination").value = "";
        if (directionsRenderer?.setDirections)
            directionsRenderer.setDirections({ routes: [] });
        localStorage.removeItem("lastOrigin");
        localStorage.removeItem("lastDestination");
    });

    loadGoogleMaps();
});

async function loadGoogleMaps() {
    if (window.google && window.google.maps) {
        initMap();
        return;
    }

    let key = sessionStorage.getItem("GOOGLE_MAPS_KEY");
    if (!key) {
        try {
            const res = await fetch("/api/google-key");
            if (!res.ok) throw new Error("Failed to get key");
            const data = await res.json();
            key = data.key;
            sessionStorage.setItem("GOOGLE_MAPS_KEY", key);
        } catch (err) {
            console.error("Google Maps load error:", err);
            document.getElementById("mapLoading").innerHTML = 
                '<div class="text-center p-8"><p class="text-red-600">Map failed to load. Please check your connection.</p></div>';
            return;
        }
    }

    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}
</script>
  </body>
</html>
