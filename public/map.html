<!DOCTYPE html>
<html lang="en" class="transition-colors">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>naviga8</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-[url('./bg-lines.svg')] min-h-screen flex flex-col items-center"
  >
    <nav class="w-full px-6 py-3 flex justify-between items-center">
      <p class="text-2xl font-bold font-sans px-6 py-2">naviga8</p>
      <button
        id="getStartedBtn"
        class="rounded-lg text-white text-[18px] px-6 py-2 bg-green-800 hover:bg-green-700 transition-colors duration-300 font-bold font-serif"
      >
        Get started for free!
      </button>
    </nav>

    <div class="text-center mt-12 px-4">
      <h1
        class="font-sans font-bold tracking-tighter leading-[1.1] text-black max-w-[1100px] mx-auto text-5xl sm:text-6xl md:text-7xl lg:text-[100px]"
      >
        Find Your Way with Seamless <br />Navigation
      </h1>

      <p
        class="text-gray-600 font-medium text-lg sm:text-xl md:text-2xl max-w-[800px] mx-auto mt-6 mb-8"
      >
        Discover locations, search for places, and get accurate directions with
        our intuitive map app. Simplify your journeys like never before.
      </p>

      <div class="flex justify-center gap-4 mb-24 flex-wrap">
        <button
          id="exploreMapBtn"
          class="bg-green-800 rounded-lg text-white text-[18px] px-6 py-2 hover:bg-green-700 transition-colors duration-300 font-bold font-serif"
        >
          Explore App Below
        </button>
      </div>

      <div class="bg-gray-200 p-8 rounded-lg max-w-[1200px] mx-auto mb-24">
        <div class="flex justify-start mb-6">
          <button
            id="viewSavedRoutesBtn"
            class="bg-green-800 rounded-lg text-white text-[18px] px-6 py-2 hover:bg-green-700 transition-colors duration-300 font-bold font-serif"
          >
            View Saved Routes
          </button>
        </div>

        <div class="flex gap-4 flex-wrap items-center">
          <div class="flex gap-2 flex-1">
            üìç<input
              id="origin"
              placeholder="Origin"
              class="flex-1 px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
            üìç<input
              id="destination"
              placeholder="Destination"
              class="flex-1 px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>

          <button
            id="getRoutesBtn"
            class="bg-green-800 rounded-lg text-white text-[18px] px-6 py-2 hover:bg-green-700 transition-colors duration-300 font-bold font-serif"
          >
            Get Routes
          </button>

          <button
            id="saveRouteBtn"
            class="bg-green-800 rounded-lg text-white text-[18px] px-6 py-2 hover:bg-green-700 transition-colors duration-300 font-bold font-serif flex items-center gap-1"
          >
            Save Route
          </button>

          <button
            id="clearBtn"
            class="text-red-600 font-bold hover:underline px-4 py-2 rounded border border-red-600"
          >
            üóë Clear
          </button>
        </div>

        <div
          id="map"
          class="mt-8 w-full h-[500px] bg-gray-300 rounded-lg flex items-center justify-center text-gray-600 font-bold"
        >
          Loading map...
        </div>
      </div>
    </div>

    <script>
      let map;
      let directionsService;
      let directionsRenderer;

      function saveInputsLocally() {
        localStorage.setItem(
          "lastOrigin",
          document.getElementById("origin").value
        );
        localStorage.setItem(
          "lastDestination",
          document.getElementById("destination").value
        );
      }

      function loadInputs() {
        const o = localStorage.getItem("lastOrigin");
        const d = localStorage.getItem("lastDestination");
        if (o) document.getElementById("origin").value = o;
        if (d) document.getElementById("destination").value = d;
      }

      function initMap() {
        if (map) return; // prevent reinitializing

        const defaultCenter = { lat: 6.866687, lng: 7.411784 };
        const savedCenter =
          JSON.parse(sessionStorage.getItem("MAP_CENTER")) || defaultCenter;
        const savedZoom = parseInt(sessionStorage.getItem("MAP_ZOOM")) || 17;
        const savedType = sessionStorage.getItem("MAP_TYPE") || "roadmap";

        map = new google.maps.Map(document.getElementById("map"), {
          center: savedCenter,
          zoom: savedZoom,
          mapTypeId: savedType,
        });

        new google.maps.Marker({
          position: defaultCenter,
          map: map,
          title: "My School",
        });

        if (!directionsRenderer) {
          directionsService = new google.maps.DirectionsService();
          directionsRenderer = new google.maps.DirectionsRenderer();
          directionsRenderer.setMap(map);
        }

        loadInputs();

        const returnOrigin = sessionStorage.getItem("returnOrigin");
        const returnDestination = sessionStorage.getItem("returnDestination");
        const hadRoute = sessionStorage.getItem("hadRoute");

        if (hadRoute && returnOrigin && returnDestination) {
          document.getElementById("origin").value = returnOrigin;
          document.getElementById("destination").value = returnDestination;
          calculateRoute(returnOrigin, returnDestination);
          sessionStorage.removeItem("returnOrigin");
          sessionStorage.removeItem("returnDestination");
          sessionStorage.removeItem("hadRoute");
        }

        loadRouteFromURL();

        // Save map state when user changes it
        map.addListener("center_changed", () => {
          sessionStorage.setItem(
            "MAP_CENTER",
            JSON.stringify(map.getCenter().toJSON())
          );
        });
        map.addListener("zoom_changed", () => {
          sessionStorage.setItem("MAP_ZOOM", map.getZoom());
        });
        map.addListener("maptypeid_changed", () => {
          sessionStorage.setItem("MAP_TYPE", map.getMapTypeId());
        });
      }

      function calculateRoute(originVal, destinationVal) {
        const origin = originVal || document.getElementById("origin").value;
        const destination =
          destinationVal || document.getElementById("destination").value;

        if (!origin || !destination)
          return alert("Enter both origin and destination");
        if (!directionsService || !directionsRenderer)
          return alert("Map is not ready yet");

        directionsService.route(
          { origin, destination, travelMode: "DRIVING" },
          (result, status) => {
            if (status === "OK") {
              directionsRenderer.setDirections(result);
              saveInputsLocally();
            } else {
              alert("Route not found: " + status);
            }
          }
        );
      }

      function loadRouteFromURL() {
        const params = new URLSearchParams(window.location.search);
        const o = params.get("origin");
        const d = params.get("destination");
        if (o && d) {
          document.getElementById("origin").value = o;
          document.getElementById("destination").value = d;
          calculateRoute(o, d);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("getRoutesBtn")
          .addEventListener("click", () => calculateRoute());

        document
          .getElementById("saveRouteBtn")
          .addEventListener("click", async (e) => {
            const btn = e.currentTarget;
            const origin = document.getElementById("origin").value.trim();
            const destination = document
              .getElementById("destination")
              .value.trim();
            if (!origin || !destination)
              return alert("Enter both origin and destination!");

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = "Saving...";

            try {
              const res = await fetch("/save-route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  origin: { address: origin },
                  destination: { address: destination },
                }),
              });

              if (res.ok) {
                btn.innerHTML = "Saved ‚úî";
                setTimeout(() => {
                  btn.disabled = false;
                  btn.innerHTML = originalText;
                }, 1500);
              } else {
                const err = await res.json().catch(() => ({}));
                alert("Could not save: " + (err.msg || res.statusText));
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            } catch (err) {
              console.error(err);
              alert("Network error saving route");
              btn.disabled = false;
              btn.innerHTML = originalText;
            }
          });

        document
          .getElementById("viewSavedRoutesBtn")
          .addEventListener("click", () => {
            sessionStorage.setItem(
              "returnOrigin",
              document.getElementById("origin").value
            );
            sessionStorage.setItem(
              "returnDestination",
              document.getElementById("destination").value
            );
            sessionStorage.setItem("hadRoute", "true");
            window.location.href = "saved-routes.html";
          });

        document
          .getElementById("exploreMapBtn")
          .addEventListener("click", () => {
            window.scrollTo({
              top: document.getElementById("map").offsetTop,
              behavior: "smooth",
            });
          });

        document.getElementById("clearBtn").addEventListener("click", () => {
          document.getElementById("origin").value = "";
          document.getElementById("destination").value = "";
          if (directionsRenderer?.setDirections)
            directionsRenderer.setDirections({ routes: [] });
          localStorage.removeItem("lastOrigin");
          localStorage.removeItem("lastDestination");
        });

        // Load Google Maps with key from backend
        loadGoogleMaps();
      });

      async function loadGoogleMaps() {
        if (window.google && window.google.maps) {
          initMap();
          return;
        }

        let key = sessionStorage.getItem("GOOGLE_MAPS_KEY");
        if (!key) {
          try {
            const res = await fetch("/api/google-key");
            if (!res.ok) throw new Error("Failed to get key");
            const data = await res.json();
            key = data.key;
            sessionStorage.setItem("GOOGLE_MAPS_KEY", key);
          } catch (err) {
            console.error("Google Maps load error:", err);
            document.getElementById("map").innerText = "Map failed to load.";
            return;
          }
        }

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>
  </body>
</html>
