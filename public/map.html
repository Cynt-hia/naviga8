<!DOCTYPE html>
<html lang="en" class="transition-colors">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>naviga8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom responsive fixes */
      @media (max-width: 768px) {
        .input-group {
          flex-direction: column;
          width: 100%;
        }
        .input-group input {
          width: 100%;
          margin-bottom: 8px;
        }
        .button-group {
          flex-wrap: wrap;
          justify-content: center;
        }
        .button-group button {
          margin: 4px;
          flex: 1;
          min-width: 120px;
        }
      }
      /* Loading spinner animation */
      .loading-spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Dark mode styles */
      .dark-mode {
        background-color: #0f172a;
        color: #f1f5f9;
      }
      .dark-mode .bg-gray-200 {
        background-color: #1e293b;
      }
      .dark-mode input {
        background-color: #334155;
        color: #e2e8f0;
        border-color: #475569;
      }
      .dark-mode input::placeholder {
        color: #94a3b8;
      }
      .dark-mode input:focus {
        background-color: #475569;
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
      }
      .dark-mode .bg-white {
        background-color: #1e293b;
      }
      .dark-mode .text-gray-600 {
        color: #cbd5e1;
      }
      .dark-mode .text-black {
        color: #f1f5f9;
      }
      .dark-mode .border-red-600 {
        border-color: #f87171;
      }
      .dark-mode .text-red-600 {
        color: #f87171;
      }
    </style>
  </head>
  <body
    class="bg-[url('./bg-lines.svg')] bg-cover bg-center min-h-screen flex flex-col items-center transition-colors duration-300"
  >
    <!-- NAVIGATION -->
    <nav class="w-full px-4 py-4 flex justify-between items-center bg-white dark:bg-gray-900 shadow-lg transition-colors duration-300">
      <p class="text-xl sm:text-2xl font-bold font-sans px-4 sm:px-6 py-3 text-gray-900 dark:text-gray-100">naviga8</p>
      <div class="flex items-center gap-3">
        <!-- DARK MODE TOGGLE -->
        <button
          id="darkModeToggle"
          class="rounded-full p-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300"
          title="Toggle dark mode"
        >
          <span id="darkModeIcon" class="text-lg">üåô</span>
        </button>
        <!-- GET STARTED BUTTON -->
        <button
          id="getStartedBtn"
          class="rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 bg-gradient-to-r from-green-700 to-green-800 hover:from-green-600 hover:to-green-700 transition-all duration-300 font-bold font-serif shadow-md hover:shadow-lg"
        >
          Get started for free!
        </button>
      </div>
    </nav>

    <!-- HERO SECTION -->
    <div class="text-center mt-8 sm:mt-12 px-4 w-full">
      <h1
        class="font-sans font-bold tracking-tighter leading-[1.1] text-black dark:text-white max-w-[1100px] mx-auto text-3xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-[100px]"
      >
        Find Your Way with Seamless <br class="hidden sm:block" />Navigation
      </h1>

      <p
        class="text-gray-600 dark:text-gray-300 font-medium text-base sm:text-lg md:text-xl max-w-[800px] mx-auto mt-4 sm:mt-6 mb-6 sm:mb-8"
      >
        Discover locations, search for places, and get accurate directions with
        our intuitive map app. Simplify your journeys like never before.
      </p>

      <!-- EXPLORE BUTTON -->
      <div class="flex justify-center gap-4 mb-12 sm:mb-24 flex-wrap">
        <button
          id="exploreMapBtn"
          class="bg-gradient-to-r from-green-700 to-green-800 rounded-lg text-white text-sm sm:text-[18px] px-9 py-3 hover:from-green-600 hover:to-green-700 transition-all duration-300 font-bold font-serif shadow-md hover:shadow-lg"
        >
          Explore App Below
        </button>
      </div>

      <!-- MAP CONTAINER -->
      <div class="bg-gray-200 dark:bg-gray-800 p-4 sm:p-8 rounded-lg max-w-[1200px] mx-auto mb-12 sm:mb-24 w-full shadow-xl transition-colors duration-300">
        <!-- VIEW SAVED ROUTES BUTTON -->
        <div class="flex justify-start mb-6 sm:mb-8">
          <button
            id="viewSavedRoutesBtn"
            class="bg-gradient-to-r from-green-700 to-green-800 rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 hover:from-green-600 hover:to-green-700 transition-all duration-300 font-bold font-serif shadow-md hover:shadow-lg"
          >
            View Saved Routes
          </button>
        </div>

        <!-- INPUTS & ACTION BUTTONS -->
        <div class="flex gap-3 sm:gap-4 flex-wrap items-start">
          <div class="flex gap-2 flex-1 input-group">
            <div class="flex gap-2 flex-1 w-full">
              <span class="text-gray-700 dark:text-gray-300 text-xl">üìç</span>
              <input
                id="origin"
                placeholder="Origin"
                class="flex-1 px-3 sm:px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 dark:focus:ring-green-400 text-sm sm:text-base transition-colors duration-300"
              />
            </div>
            <div class="flex gap-2 flex-1 w-full">
              <span class="text-gray-700 dark:text-gray-300 text-xl">üìç</span>
              <input
                id="destination"
                placeholder="Destination"
                class="flex-1 px-3 sm:px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 dark:focus:ring-green-400 text-sm sm:text-base transition-colors duration-300"
              />
            </div>
          </div>

          <div class="flex gap-2 sm:gap-4 button-group w-full sm:w-auto">
            <button
              id="getRoutesBtn"
              class="bg-gradient-to-r from-green-700 to-green-800 rounded-lg text-white text-sm sm:text-[18px] px-6 py-3 hover:from-green-600 hover:to-green-700 transition-all duration-300 font-bold font-serif flex-1 shadow-md hover:shadow-lg"
            >
              Get Routes
            </button>

            <button
              id="saveRouteBtn"
              class="bg-gradient-to-r from-green-700 to-green-800 rounded-lg text-white text-sm sm:text-[18px] px-6 py-3 hover:from-green-600 hover:to-green-700 transition-all duration-300 font-bold font-serif flex items-center gap-1 flex-1 shadow-md hover:shadow-lg"
            >
              Save Route
            </button>

            <button
              id="clearBtn"
              class="text-red-600 dark:text-red-400 font-bold hover:underline px-5 py-3 rounded-lg border border-red-600 dark:border-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm sm:text-base flex-1 transition-colors duration-300"
            >
              üóë Clear
            </button>
          </div>
        </div>

        <!-- MAP DISPLAY WITH LOADING -->
        <div
          id="map"
          class="mt-6 sm:mt-8 w-full h-[300px] sm:h-[400px] md:h-[500px] bg-gray-300 dark:bg-gray-700 rounded-lg relative overflow-hidden transition-colors duration-300"
        >
          <!-- LOADING SPINNER -->
          <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-300 dark:bg-gray-700 transition-colors duration-300">
            <div class="text-center">
              <div class="inline-block loading-spinner rounded-full h-10 w-10 border-4 border-green-800 dark:border-green-400 border-t-transparent"></div>
              <p class="mt-3 text-gray-700 dark:text-gray-300 font-medium">Loading map...</p>
            </div>
          </div>
          <!-- ACTUAL MAP CONTAINER (HIDDEN INITIALLY) -->
          <div id="mapContainer" class="hidden w-full h-full"></div>
        </div>
      </div>
    </div>

<script>
// ====== DARK MODE ======
function initDarkMode() {
  const darkModeToggle = document.getElementById("darkModeToggle");
  const darkModeIcon = document.getElementById("darkModeIcon");
  
  // Check saved preference
  const isDarkMode = localStorage.getItem("naviga8_darkMode") === "true";
  
  if (isDarkMode) {
    document.body.classList.add("dark-mode");
    darkModeIcon.textContent = "‚òÄÔ∏è";
  }
  
  // Toggle dark mode
  darkModeToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    darkModeIcon.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("naviga8_darkMode", isDark);
  });
}

// ====== USER ID ======
let userId = localStorage.getItem("naviga8_userId");

async function getOrCreateUserId() {
    if (userId) return userId;
    try {
        const res = await fetch("/api/user-id");
        if (!res.ok) throw new Error("Failed to get user ID");
        const data = await res.json();
        userId = data.userId;
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    } catch (err) {
        console.error("User ID error:", err);
        userId = Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    }
}

// ====== MAP FUNCTIONS ======
let map;
let directionsService;
let directionsRenderer;

function saveInputsLocally() {
    localStorage.setItem("lastOrigin", document.getElementById("origin").value);
    localStorage.setItem("lastDestination", document.getElementById("destination").value);
}

function loadInputs() {
    const o = localStorage.getItem("lastOrigin");
    const d = localStorage.getItem("lastDestination");
    if (o) document.getElementById("origin").value = o;
    if (d) document.getElementById("destination").value = d;
}

function initMap() {
    if (map) return;

    const defaultCenter = { lat: 6.866687, lng: 7.411784 };
    const savedCenter = JSON.parse(sessionStorage.getItem("MAP_CENTER")) || defaultCenter;
    const savedZoom = parseInt(sessionStorage.getItem("MAP_ZOOM")) || 17;
    const savedType = sessionStorage.getItem("MAP_TYPE") || "roadmap";

    // Create map in the mapContainer (not directly in #map)
    map = new google.maps.Map(document.getElementById("mapContainer"), {
        center: savedCenter,
        zoom: savedZoom,
        mapTypeId: savedType,
    });

    new google.maps.Marker({
        position: defaultCenter,
        map: map,
        title: "My School",
    });

    if (!directionsRenderer) {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
    }

    loadInputs();

    const returnOrigin = sessionStorage.getItem("returnOrigin");
    const returnDestination = sessionStorage.getItem("returnDestination");
    const hadRoute = sessionStorage.getItem("hadRoute");

    if (hadRoute && returnOrigin && returnDestination) {
        document.getElementById("origin").value = returnOrigin;
        document.getElementById("destination").value = returnDestination;
        calculateRoute(returnOrigin, returnDestination);
        sessionStorage.removeItem("returnOrigin");
        sessionStorage.removeItem("returnDestination");
        sessionStorage.removeItem("hadRoute");
    }

    loadRouteFromURL();

    // Hide loading spinner, show map
    document.getElementById("mapLoading").classList.add("hidden");
    document.getElementById("mapContainer").classList.remove("hidden");

    map.addListener("center_changed", () => {
        sessionStorage.setItem("MAP_CENTER", JSON.stringify(map.getCenter().toJSON()));
    });
    map.addListener("zoom_changed", () => {
        sessionStorage.setItem("MAP_ZOOM", map.getZoom());
    });
    map.addListener("maptypeid_changed", () => {
        sessionStorage.setItem("MAP_TYPE", map.getMapTypeId());
    });
}

function calculateRoute(originVal, destinationVal) {
    const origin = originVal || document.getElementById("origin").value;
    const destination = destinationVal || document.getElementById("destination").value;

    if (!origin || !destination) {
        alert("Enter both origin and destination");
        return;
    }
    
    if (!directionsService || !directionsRenderer) {
        alert("Map is not ready yet");
        return;
    }

    // Show loading state on button
    const routeBtn = document.getElementById("getRoutesBtn");
    const originalText = routeBtn.innerHTML;
    routeBtn.innerHTML = "Calculating...";
    routeBtn.disabled = true;

    directionsService.route(
        { origin, destination, travelMode: "DRIVING" },
        (result, status) => {
            // Restore button
            routeBtn.disabled = false;
            routeBtn.innerHTML = originalText;
            
            if (status === "OK") {
                directionsRenderer.setDirections(result);
                saveInputsLocally();
            } else {
                alert("Route not found: " + status);
            }
        }
    );
}

function loadRouteFromURL() {
    const params = new URLSearchParams(window.location.search);
    const o = params.get("origin");
    const d = params.get("destination");
    if (o && d) {
        document.getElementById("origin").value = o;
        document.getElementById("destination").value = d;
        calculateRoute(o, d);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    // Initialize dark mode
    initDarkMode();
    
    document.getElementById("getStartedBtn").addEventListener("click", () => {
        document.getElementById("map").scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("getRoutesBtn").addEventListener("click", () => calculateRoute());

    document.getElementById("saveRouteBtn").addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        const origin = document.getElementById("origin").value.trim();
        const destination = document.getElementById("destination").value.trim();
        if (!origin || !destination)
            return alert("Enter both origin and destination!");

        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = "Saving...";

        try {
            const currentUserId = await getOrCreateUserId();
            const res = await fetch("/save-route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: currentUserId,
                    origin: { address: origin },
                    destination: { address: destination },
                }),
            });

            if (res.ok) {
                btn.innerHTML = "Saved ‚úî";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 1500);
            } else {
                const err = await res.json().catch(() => ({}));
                alert("Could not save: " + (err.msg || res.statusText));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (err) {
            console.error(err);
            alert("Network error saving route");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    document.getElementById("viewSavedRoutesBtn").addEventListener("click", () => {
        sessionStorage.setItem("returnOrigin", document.getElementById("origin").value);
        sessionStorage.setItem("returnDestination", document.getElementById("destination").value);
        sessionStorage.setItem("hadRoute", "true");
        window.location.href = "saved-routes.html";
    });

    document.getElementById("exploreMapBtn").addEventListener("click", () => {
        window.scrollTo({
            top: document.getElementById("map").offsetTop,
            behavior: "smooth"
        });
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("origin").value = "";
        document.getElementById("destination").value = "";
        if (directionsRenderer?.setDirections)
            directionsRenderer.setDirections({ routes: [] });
        localStorage.removeItem("lastOrigin");
        localStorage.removeItem("lastDestination");
    });

    loadGoogleMaps();
});

async function loadGoogleMaps() {
    if (window.google && window.google.maps) {
        initMap();
        return;
    }

    let key = sessionStorage.getItem("GOOGLE_MAPS_KEY");
    if (!key) {
        try {
            const res = await fetch("/api/google-key");
            if (!res.ok) throw new Error("Failed to get key");
            const data = await res.json();
            key = data.key;
            sessionStorage.setItem("GOOGLE_MAPS_KEY", key);
        } catch (err) {
            console.error("Google Maps load error:", err);
            document.getElementById("mapLoading").innerHTML = 
                '<div class="text-center p-8"><p class="text-red-600 dark:text-red-400">Map failed to load. Please check your connection.</p></div>';
            return;
        }
    }

    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}
</script>
  </body>
</html>
