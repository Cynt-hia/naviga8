<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>naviga8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom responsive fixes */
      @media (max-width: 768px) {
        .input-group {
          flex-direction: column;
          width: 100%;
        }
        .input-group input {
          width: 100%;
          margin-bottom: 8px;
        }
        .button-group {
          flex-wrap: wrap;
          justify-content: center;
        }
        .button-group button {
          margin: 4px;
          flex: 1;
          min-width: 120px;
        }
      }
      /* Loading spinner animation */
      .loading-spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Animated background */
      .bg-animated-grid {
        background: 
          linear-gradient(90deg, #f0f9ff 1px, transparent 1px) 0 0 / 40px 40px,
          linear-gradient(#f0f9ff 1px, transparent 1px) 0 0 / 40px 40px,
          #ffffff;
        animation: gridMove 80s linear infinite;
      }
      
      @keyframes gridMove {
        0% { background-position: 0 0, 0 0; }
        100% { background-position: 80px 80px, 80px 80px; }
      }
      
      /* Smooth transitions */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body class="bg-animated-grid min-h-screen flex flex-col items-center">
    <!-- NAVIGATION -->
    <nav class="w-full px-4 py-4 flex justify-between items-center">
      <p class="text-xl sm:text-2xl font-bold font-sans px-4 sm:px-6 py-3">naviga8</p>
      <button
        id="getStartedBtn"
        class="rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 bg-green-700 hover:bg-green-800 transition-colors font-bold font-serif"
      >
        Get started for free!
      </button>
    </nav>

    <!-- HERO SECTION -->
    <div class="text-center mt-8 sm:mt-12 px-4 w-full">
      <h1
        class="font-sans font-bold tracking-tighter leading-[1.1] text-black max-w-[1100px] mx-auto text-3xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-[100px] fade-in"
      >
        Find Your Way with Seamless <br class="hidden sm:block" />Navigation
      </h1>

      <p
        class="text-gray-600 font-medium text-base sm:text-lg md:text-xl max-w-[800px] mx-auto mt-4 sm:mt-6 mb-6 sm:mb-8 fade-in"
      >
        Discover locations, search for places, and get accurate directions with
        our intuitive map app. Simplify your journeys like never before.
      </p>

      <!-- EXPLORE BUTTON -->
      <div class="flex justify-center gap-4 mb-12 sm:mb-24 flex-wrap fade-in">
        <button
          id="exploreMapBtn"
          class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-9 py-3 hover:bg-green-800 transition-colors font-bold font-serif transform hover:scale-105 transition-transform"
        >
          Explore App Below
        </button>
      </div>

      <!-- MAP CONTAINER -->
      <div class="bg-white p-4 sm:p-8 rounded-lg max-w-[1200px] mx-auto mb-12 sm:mb-24 w-full shadow-xl border border-gray-200">
        <!-- VIEW SAVED ROUTES BUTTON -->
        <div class="flex justify-between mb-6 sm:mb-8">
          <button
            id="viewSavedRoutesBtn"
            class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-7 py-3 hover:bg-green-800 transition-colors font-bold font-serif transform hover:scale-105 transition-transform"
          >
            üìÅ View Saved Routes
          </button>
        </div>

        <!-- INPUTS & ACTION BUTTONS -->
        <div class="flex gap-3 sm:gap-4 flex-wrap items-start">
          <div class="flex gap-2 flex-1 input-group">
            <div class="flex gap-2 flex-1 w-full">
              <span class="text-gray-700 text-xl">üìç</span>
              <input
                id="origin"
                placeholder="Enter origin (address, city, landmark)"
                class="flex-1 px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm sm:text-base"
              />
            </div>
            <div class="flex gap-2 flex-1 w-full">
              <span class="text-gray-700 text-xl">üìç</span>
              <input
                id="destination"
                placeholder="Enter destination (address, city, landmark)"
                class="flex-1 px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm sm:text-base"
              />
            </div>
          </div>

          <div class="flex gap-2 sm:gap-4 button-group w-full sm:w-auto">
            <button
              id="getRoutesBtn"
              class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-6 py-3 hover:bg-green-800 transition-colors font-bold font-serif flex-1 transform hover:scale-105 transition-transform"
            >
              üöó Get Routes
            </button>

            <button
              id="saveRouteBtn"
              class="bg-green-700 rounded-lg text-white text-sm sm:text-[18px] px-6 py-3 hover:bg-green-800 transition-colors font-bold font-serif flex items-center gap-1 flex-1 transform hover:scale-105 transition-transform"
            >
              üíæ Save Route
            </button>

            <button
              id="clearBtn"
              class="text-red-600 font-bold hover:underline px-5 py-3 rounded-lg border border-red-600 hover:bg-red-50 text-sm sm:text-base flex-1 transition-colors transform hover:scale-105 transition-transform"
            >
              üóëÔ∏è Clear
            </button>
          </div>
        </div>

        <!-- ROUTE DETAILS -->
        <div id="routeDetails" class="hidden mt-6 p-4 bg-green-50 rounded-lg border border-green-200 fade-in">
          <h3 class="font-bold text-lg mb-3 text-green-800">Route Details</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="text-center p-3 bg-white rounded shadow">
              <div class="text-2xl mb-2">üìè</div>
              <p class="font-bold text-gray-800 text-xl" id="distanceText">--</p>
              <p class="text-sm text-gray-600">Distance</p>
            </div>
            <div class="text-center p-3 bg-white rounded shadow">
              <div class="text-2xl mb-2">‚è±Ô∏è</div>
              <p class="font-bold text-gray-800 text-xl" id="durationText">--</p>
              <p class="text-sm text-gray-600">Duration</p>
            </div>
          </div>
        </div>

        <!-- MAP DISPLAY WITH LOADING -->
        <div
          id="map"
          class="mt-6 sm:mt-8 w-full h-[300px] sm:h-[400px] md:h-[500px] bg-gray-100 rounded-lg border border-gray-300 relative overflow-hidden"
        >
          <!-- LOADING SPINNER -->
          <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-100">
            <div class="text-center">
              <div class="inline-block loading-spinner rounded-full h-12 w-12 border-4 border-green-600 border-t-transparent"></div>
              <p class="mt-4 text-gray-700 font-medium">Loading map...</p>
              <p class="text-sm text-gray-500 mt-1">Powered by Google Maps</p>
            </div>
          </div>
          <!-- ACTUAL MAP CONTAINER (HIDDEN INITIALLY) -->
          <div id="mapContainer" class="hidden w-full h-full"></div>
        </div>
      </div>
    </div>

<script>
// ====== USER ID ======
let userId = localStorage.getItem("naviga8_userId");

async function getOrCreateUserId() {
    if (userId) return userId;
    try {
        const res = await fetch("/api/user-id");
        if (!res.ok) throw new Error("Failed to get user ID");
        const data = await res.json();
        userId = data.userId;
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    } catch (err) {
        console.error("User ID error:", err);
        userId = Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        localStorage.setItem("naviga8_userId", userId);
        return userId;
    }
}

// ====== MAP FUNCTIONS ======
let map;
let directionsService;
let directionsRenderer;
let autocomplete1, autocomplete2;

function saveInputsLocally() {
    localStorage.setItem("lastOrigin", document.getElementById("origin").value);
    localStorage.setItem("lastDestination", document.getElementById("destination").value);
}

function loadInputs() {
    const o = localStorage.getItem("lastOrigin");
    const d = localStorage.getItem("lastDestination");
    if (o) document.getElementById("origin").value = o;
    if (d) document.getElementById("destination").value = d;
}

function initMap() {
    if (map) return;

    const defaultCenter = { lat: 6.866687, lng: 7.411784 };
    const savedCenter = JSON.parse(sessionStorage.getItem("MAP_CENTER")) || defaultCenter;
    const savedZoom = parseInt(sessionStorage.getItem("MAP_ZOOM")) || 17;
    const savedType = sessionStorage.getItem("MAP_TYPE") || "roadmap";

    // Create map in the mapContainer (not directly in #map)
    map = new google.maps.Map(document.getElementById("mapContainer"), {
        center: savedCenter,
        zoom: savedZoom,
        mapTypeId: savedType,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
    });

    new google.maps.Marker({
        position: defaultCenter,
        map: map,
        title: "My School",
        icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        }
    });

    // Initialize autocomplete if Google Places is available
    if (window.google.maps.places) {
        const originInput = document.getElementById('origin');
        const destInput = document.getElementById('destination');
        
        autocomplete1 = new google.maps.places.Autocomplete(originInput, {
            types: ['geocode'],
            componentRestrictions: { country: 'ng' }
        });
        
        autocomplete2 = new google.maps.places.Autocomplete(destInput, {
            types: ['geocode'],
            componentRestrictions: { country: 'ng' }
        });
    }

    if (!directionsRenderer) {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false,
            polylineOptions: {
                strokeColor: '#10b981',
                strokeWeight: 5,
                strokeOpacity: 0.8
            }
        });
    }

    loadInputs();

    const returnOrigin = sessionStorage.getItem("returnOrigin");
    const returnDestination = sessionStorage.getItem("returnDestination");
    const hadRoute = sessionStorage.getItem("hadRoute");

    if (hadRoute && returnOrigin && returnDestination) {
        document.getElementById("origin").value = returnOrigin;
        document.getElementById("destination").value = returnDestination;
        calculateRoute(returnOrigin, returnDestination);
        sessionStorage.removeItem("returnOrigin");
        sessionStorage.removeItem("returnDestination");
        sessionStorage.removeItem("hadRoute");
    }

    loadRouteFromURL();

    // Hide loading spinner, show map
    document.getElementById("mapLoading").classList.add("hidden");
    document.getElementById("mapContainer").classList.remove("hidden");

    map.addListener("center_changed", () => {
        sessionStorage.setItem("MAP_CENTER", JSON.stringify(map.getCenter().toJSON()));
    });
    map.addListener("zoom_changed", () => {
        sessionStorage.setItem("MAP_ZOOM", map.getZoom());
    });
    map.addListener("maptypeid_changed", () => {
        sessionStorage.setItem("MAP_TYPE", map.getMapTypeId());
    });
}

function calculateRoute(originVal, destinationVal) {
    const origin = originVal || document.getElementById("origin").value;
    const destination = destinationVal || document.getElementById("destination").value;

    if (!origin || !destination) {
        alert("Please enter both origin and destination");
        return;
    }
    
    if (!directionsService || !directionsRenderer) {
        alert("Map is not ready yet. Please wait...");
        return;
    }

    // Show loading state on button
    const routeBtn = document.getElementById("getRoutesBtn");
    const originalText = routeBtn.innerHTML;
    routeBtn.innerHTML = "Calculating...";
    routeBtn.disabled = true;

    directionsService.route(
        {
            origin: origin,
            destination: destination,
            travelMode: "DRIVING",
            provideRouteAlternatives: true
        },
        (result, status) => {
            // Restore button
            routeBtn.disabled = false;
            routeBtn.innerHTML = originalText;
            
            if (status === "OK") {
                directionsRenderer.setDirections(result);
                saveInputsLocally();
                showRouteDetails(result);
            } else {
                alert("Route not found. Please check your addresses. Error: " + status);
            }
        }
    );
}

function showRouteDetails(result) {
    if (!result.routes || result.routes.length === 0) return;
    
    const route = result.routes[0];
    if (!route.legs || route.legs.length === 0) return;
    
    const leg = route.legs[0];
    document.getElementById("distanceText").textContent = leg.distance?.text || "--";
    document.getElementById("durationText").textContent = leg.duration?.text || "--";
    
    // Show the details section with animation
    const detailsDiv = document.getElementById("routeDetails");
    detailsDiv.classList.remove("hidden");
    detailsDiv.classList.add("fade-in");
}

function loadRouteFromURL() {
    const params = new URLSearchParams(window.location.search);
    const o = params.get("origin");
    const d = params.get("destination");
    if (o && d) {
        document.getElementById("origin").value = o;
        document.getElementById("destination").value = d;
        calculateRoute(o, d);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("getStartedBtn").addEventListener("click", () => {
        document.getElementById("map").scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("getRoutesBtn").addEventListener("click", () => calculateRoute());

    document.getElementById("saveRouteBtn").addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        const origin = document.getElementById("origin").value.trim();
        const destination = document.getElementById("destination").value.trim();
        if (!origin || !destination)
            return alert("Please enter both origin and destination!");

        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = "Saving...";

        try {
            const currentUserId = await getOrCreateUserId();
            const res = await fetch("/save-route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: currentUserId,
                    origin: { address: origin },
                    destination: { address: destination },
                }),
            });

            if (res.ok) {
                btn.innerHTML = "Saved ‚úî";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 1500);
            } else {
                const err = await res.json().catch(() => ({}));
                alert("Could not save: " + (err.msg || res.statusText));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (err) {
            console.error(err);
            alert("Network error saving route");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    document.getElementById("viewSavedRoutesBtn").addEventListener("click", () => {
        sessionStorage.setItem("returnOrigin", document.getElementById("origin").value);
        sessionStorage.setItem("returnDestination", document.getElementById("destination").value);
        sessionStorage.setItem("hadRoute", "true");
        window.location.href = "saved-routes.html";
    });

    document.getElementById("exploreMapBtn").addEventListener("click", () => {
        window.scrollTo({
            top: document.getElementById("map").offsetTop - 20,
            behavior: "smooth"
        });
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("origin").value = "";
        document.getElementById("destination").value = "";
        if (directionsRenderer?.setDirections)
            directionsRenderer.setDirections({ routes: [] });
        localStorage.removeItem("lastOrigin");
        localStorage.removeItem("lastDestination");
        document.getElementById("routeDetails").classList.add("hidden");
    });

    // Enter key support for inputs
    document.getElementById("origin").addEventListener("keypress", (e) => {
        if (e.key === "Enter") calculateRoute();
    });
    
    document.getElementById("destination").addEventListener("keypress", (e) => {
        if (e.key === "Enter") calculateRoute();
    });

    loadGoogleMaps();
});

async function loadGoogleMaps() {
    if (window.google && window.google.maps) {
        initMap();
        return;
    }

    let key = sessionStorage.getItem("GOOGLE_MAPS_KEY");
    if (!key) {
        try {
            const res = await fetch("/api/google-key");
            if (!res.ok) throw new Error("Failed to get key");
            const data = await res.json();
            key = data.key;
            sessionStorage.setItem("GOOGLE_MAPS_KEY", key);
        } catch (err) {
            console.error("Google Maps load error:", err);
            document.getElementById("mapLoading").innerHTML = 
                '<div class="text-center p-8"><p class="text-red-600">Map failed to load. Please check your connection.</p></div>';
            return;
        }
    }

    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}
</script>
  </body>
</html>
